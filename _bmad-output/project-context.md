---
project_name: 'tycs'
user_name: 'Ducdo'
date: '2026-02-26'
sections_completed: ['technology_stack', 'language_rules', 'framework_rules', 'testing_rules', 'code_quality', 'dev_workflow', 'anti_patterns']
status: 'complete'
rule_count: 65
optimized_for_llm: true
---

# Project Context for AI Agents

_Critical rules and patterns for AI agents implementing code in tycs. One page. Read before every story._

---

## Technology Stack & Versions

**Monorepo:** Turborepo + pnpm workspaces
**Runtime:** Node.js >=20 (enforced via `.nvmrc` + `engines`)

**Apps:**
- `apps/webapp` — React 19, Vite + SWC, React Router v7 (SPA mode, browser history)
- `apps/website` — Astro (static), React islands from `@tycs/ui`
- `apps/backend` — Fastify + pino (structured JSON logging), Kysely, BullMQ

**Shared Packages (internal — TypeScript source, NO build step):**
- `@tycs/ui` — shadcn/ui + Tailwind CSS v4 preset
- `@tycs/shared` — types, constants, `toCamelCase()`. NO runtime deps. `src/types/db.ts` is generated by `kysely-codegen` (gitignored — run `pnpm --filter shared db:types` after migrations)
- `@tycs/execution` — Fly Machine config, typed SSE events (discriminated union), benchmark runner
- `@tycs/config` — ESLint, TS base, Vitest base, canonical test utilities + mock factories

**Infrastructure:** PostgreSQL 16, Redis 7 (via ioredis — NOT the `redis` npm package), Go 1.23 (execution image)

**External Services:** Firebase Auth, Anthropic API (Haiku 4.5 default / Sonnet 4.6 for code analysis), Fly.io Machines API, Sentry

**Test Stack:** Vitest (NOT Jest — use `vi.fn()`, `vi.mock()`), Playwright (NOT Cypress), msw v2 (`http.get()` not `rest.get()`)

**Critical:** PRD references Drizzle in some sections. **Kysely is authoritative.** Never use Drizzle.

---

## Language-Specific Rules

**Import Paths:**
- Internal packages: `import { ... } from '@tycs/shared'` — configured in `tsconfig.json` `paths`
- Within an app: **relative paths only** — no `@/` aliases (Vite and Fastify resolve aliases differently)
- Never import from another Fastify plugin's internals — only from `shared/` and `packages/*`

**Barrel Files (`index.ts`):**
- Every module/plugin exports via `index.ts` — not exported = private
- Exception: `@tycs/ui` has NO barrel file — import components individually for tree-shaking
- Exported functions must have explicit return types

**Type Conventions:**
- `PascalCase` for types/interfaces — no `I` prefix (`Submission`, not `ISubmission`)
- `T | null` for absent values — never `undefined` in API responses
- DB types generated by `kysely-codegen` — never hand-write DB interfaces
- Union types for enums: `type SubmissionStatus = 'queued' | 'running' | 'completed' | 'failed'` — never TS `enum`
- No `as` casting (only `as const`). Use `satisfies` for config validation: `const config = { ... } satisfies FlyMachineConfig`
- No `any` — including test files. Use `Partial<T>` or canonical mock factories
- `readonly` on function params for shared data (events, configs, benchmark payloads)

**DB→API Conversion (agents WILL forget this):**
```typescript
// EVERY route handler — snake_case DB → camelCase API
reply.send(toCamelCase(await db.selectFrom('submissions').where('user_id', '=', uid).executeTakeFirstOrThrow()))
```

**Error Handling — Two Paths:**
- **User-code errors** (compilation failures, test failures): SSE event payloads. HTTP is always 200 OK.
- **Platform errors** (API failures, infra issues): HTTP status codes (500, 503) → Sentry
- User-code errors must NEVER trigger Sentry. Platform errors must NEVER appear as terminal output.

**Async:** Always `async/await` — no `.then()` chains. Fastify route handlers return the response directly.

---

## Framework-Specific Rules

### Fastify (Backend)

**Plugin Registration Order** in `app.ts` (new plugins MUST document position):
1. Auth plugin (global `onRequest` hook — must be first)
2. Rate limiter (depends on auth for `uid`)
3. Domain plugins (depend on auth + rate limiter)

**Plugin Isolation:** Plugins only import from `shared/` and `packages/*` — NEVER cross-plugin. Cross-domain communication via database or Redis.

**Request Decorator Pattern:**
```typescript
// Auth plugin decorates request — downstream routes read request.uid
fastify.decorateRequest('uid', '')
declare module 'fastify' { interface FastifyRequest { uid: string } }
```

**Route Responses:** `return { data }` for JSON (Fastify auto-serializes). Only use `reply.raw` for SSE streaming. Never double-send.

**SSE Routes:** Must override `connectionTimeout: 0` to prevent Fastify killing the connection. 30s manual heartbeat within Railway's 5-min hard timeout.

**Route Testing:** `fastify.inject()` only — never supertest, never real HTTP.

**Validation:** JSON Schema at API boundary only. Trust internal data.

**API Response Shape:** Direct object for success (no wrapper). `{ error: { code, message } }` for errors.

### React (Webapp)

**State Split — hard rule:**
- Server state → TanStack Query (key pattern: `['domain', 'action', params]`)
- UI state → Zustand (2 stores ONLY: `useWorkspaceUIStore`, `useEditorStore`)
- Never server data in Zustand. Never UI state in TanStack Query.

**`apiFetch` location:** `apps/webapp/src/lib/api-fetch.ts` — NOT in `@tycs/shared` (depends on Firebase client SDK).

**TanStack Query:** Set `staleTime` appropriately — workspace data should be long (5 min). Default 0ms causes constant background refetches.

**Workspace Component Tree:** `CriteriaPanel` + milestone brief are SIBLINGS of the lazy Monaco boundary, not children. Brief renders immediately; Monaco shows `<WorkspaceSkeleton />` while loading.

**TutorPanel has 3 states:** collapsed, expanded, `unavailable` (distinct visual state + retry button). Not just open/closed.

**Components:** Organized by feature/route, not by type. Common in `components/common/`.

**Loading:** Purpose-built skeleton per screen. No generic spinners.

**Monaco:** Wrapped in `<CodeEditor>` boundary. Unit tests mock the wrapper. Go language only.

**Font Loading:** `font-display: optional` (webapp). Do NOT copy from Astro config (`swap`).

### Astro (Website)

Pure static. No auth, no runtime API calls. Reads `content/milestones/01-kv-store/` at build time for Milestone 1 preview. React islands from `@tycs/ui` for interactive components. `font-display: swap` (prioritize LCP).

---

## Testing Rules

**File Location:** Co-located `{source}.test.ts` next to source. Never `.spec.ts`, never `__tests__/`. Exception: Playwright E2E in `apps/webapp/e2e/`.

**Test Syntax:** Always `it()`, never `test()`. `describe` mirrors module structure:
```typescript
describe('ContextAssembler', () => {
  describe('assembleSystemPrompt', () => {
    it('should include milestone brief when session is active', () => {});
  });
});
```

**Test names describe behavior, not implementation:** `it('should return 401 when token is expired')` — good. `it('should call verifyIdToken')` — bad.

**Test Isolation:**
- `vi.restoreAllMocks()` in `afterEach` — always
- No `beforeAll` for test data — use `beforeEach` or inline factories (`beforeAll` only for Fastify instance setup)
- No shared mutable state between tests

**Database:** Real PostgreSQL in ALL environments — never SQLite, never in-memory. Kysely test transaction per test, rolled back in `afterEach`.

**Two Test Worlds — never mix:**
- **Component/unit:** Vitest + `@testing-library/react` in `*.test.tsx`
- **E2E:** Playwright in `apps/webapp/e2e/` only — different runner, different assertions

**Mock Boundary Rule:** Only mock what you don't own. Never mock Kysely `.execute()` (use real DB) or Fastify `reply` (use `fastify.inject()`). Mocks are for external services only:

| External Service | Mock Strategy |
|---|---|
| Fly Machines API | `msw` v2 HTTP handlers |
| Firebase Auth | Mock `verifyIdToken()` → test uid |
| Anthropic SDK | Scripted streaming chunks |
| SSE (`useSSE`) | Injectable `EventSource` constructor |
| TanStack Query | `createTestQueryClient()` (no retries, no cache) + `TestProviders` |

**Import from `@tycs/config/test-utils/`** — never create ad-hoc mocks. New patterns → add to canonical set.

**Banned Patterns:**
- Snapshot tests (`toMatchSnapshot()`) — use explicit behavioral assertions
- Silent `describe.skip` / `it.skip` — must include `// TODO(story-id): reason`

**Boundary Tests Required:**
- User-code errors never trigger Sentry
- Platform errors never appear as terminal output

---

## Code Quality & Style

**Naming Conventions:**

| Concern | Convention | Example |
|---|---|---|
| DB tables/columns | `snake_case` | `code_snapshots`, `user_id`, `created_at` |
| Foreign keys | `{table_singular}_id` | `session_id`, `milestone_id` |
| Indexes | `idx_{table}_{columns}` | `idx_submissions_user_id_milestone_id` |
| API response fields | `camelCase` | `milestoneId`, `createdAt` |
| SSE event types | `snake_case` | `compile_output`, `benchmark_result` (NOT camelCase) |
| Route paths | `kebab-case`, plural | `/api/execution/submissions` |
| BullMQ jobs | `{domain}:{action}` | `execution:run`, `progress:auto-save` |
| Files (utilities) | `kebab-case.ts` | `api-fetch.ts`, `execution-plugin.ts` |
| Files (components) | `PascalCase.tsx` | `TutorPanel.tsx`, `CodeEditor.tsx` |
| Constants | `SCREAMING_SNAKE_CASE` | `MAX_MESSAGE_LENGTH`, `HEARTBEAT_INTERVAL_MS` |
| Zustand stores | `use{Name}Store` | `useWorkspaceUIStore` |
| Env vars (custom) | `TYCS_` prefix | `TYCS_FLY_API_TOKEN` (third-party keep standard: `ANTHROPIC_API_KEY`) |

**IDs:** `cuid2` for all entities. Exception: `users.id` = Firebase UID. Never auto-increment, never UUID.

**Pagination:** Cursor-based everywhere — `?afterCursor={lastId}&pageSize=20`. Never offset.

**Timestamps:** `timestamptz` in DB, ISO 8601 in API. Display formatting in frontend only.

**Exports:** Named exports only — no default exports. Enables clean barrel re-exports.

**Dependency Injection:** Every Fastify plugin accepts dependencies via options (Redis client, Anthropic SDK instance). Never hardcode connections — injectable for testability.

**Content Directory:** `content/` is NOT a pnpm workspace. No `package.json`, no TypeScript, no build step. Read at runtime (backend) or build time (Astro). Never add to `pnpm-workspace.yaml`.

**Logging Privacy:** Never log user code content or AI conversation content at `info` level or above.

---

## Development Workflow

**Local Setup:**
```bash
docker compose up -d          # PostgreSQL 16 + Redis 7
pnpm install                  # All dependencies
pnpm dev                      # Turborepo runs all 3 apps concurrently
```

**After Schema Changes:**
```bash
pnpm --filter backend db:migrate    # Run Kysely migrations
pnpm --filter shared db:types       # Regenerate kysely-codegen types
```

**Backend = One Codebase, Two Railway Services:**
- `pnpm --filter backend start:api` → Fastify server (Railway web service)
- `pnpm --filter backend start:worker` → BullMQ processor (Railway worker service)
- Do NOT create a separate `apps/worker/` — it's all `apps/backend`

**Package Installation:** Always scope to the correct workspace:
```bash
pnpm --filter backend add ioredis    # ✅ App dependency
pnpm add -w turbo                     # ✅ Root tooling only
pnpm add ioredis                      # ❌ Wrong — goes to root
```

**CI Pipeline (GitHub Actions on push to main):**
1. `pnpm install --frozen-lockfile` (lock file is committed — never `pnpm install`)
2. `turbo lint` → `turbo typecheck` → `turbo test` → `turbo build`
3. Railway auto-deploys from main
4. Configure `TURBO_TOKEN` + `TURBO_TEAM` for Vercel remote caching

**Production Migrations:** Railway release command runs before API starts. Failure aborts deploy. Down migrations manual only.

**Content CI:** Separate workflow on content changes. Validates YAML against JSON schemas + runs code through Fly execution.

---

## Anti-Patterns — NEVER Do These

**Architecture violations:**
- Cross-plugin import (`import from '../../plugins/tutor/...'`)
- Create new Zustand store (exactly 2: `useWorkspaceUIStore`, `useEditorStore`)
- Create new `packages/*` directory (exactly 4: `ui`, `shared`, `execution`, `config`)
- Create `apps/worker/` (worker lives in `apps/backend` — same codebase, different entry point)
- Add `content/` to `pnpm-workspace.yaml`

**Code style violations:**
- Wrapper response: `{ data: result, success: true }` — use direct response
- Offset pagination: `?page=2&limit=20` — use cursor
- Default exports — named exports only
- `as` casting — use `satisfies` or type narrowing
- `any` type (including tests) — use `Partial<T>` or mock factories
- TS `enum` — use union types
- `@/` import aliases — relative paths within apps
- Integer IDs — `cuid2` only (except Firebase UID)
- Barrel import from `@tycs/ui` — import components individually

**Tooling violations:**
- `jest.fn()`, `jest.mock()` — use `vi.fn()`, `vi.mock()`
- `import { createClient } from 'redis'` — use `ioredis`
- `console.log` — use pino via Fastify logger
- `toMatchSnapshot()` — use explicit behavioral assertions
- `nodemon` or `ts-node-dev` — Fastify `--watch` + Vite HMR + Turborepo `dev`
- `pnpm install` in CI — always `--frozen-lockfile`
- `Date.now()` in test assertions — use `vi.useFakeTimers()` + `vi.setSystemTime()`

---

## Usage Guidelines

**For AI Agents:**
- Read this file before implementing any story
- Follow ALL rules exactly as documented
- When in doubt, prefer the more restrictive option
- Reference `architecture.md` for detailed decisions and rationale

**For Humans:**
- Keep this file lean and focused on agent needs
- Update when technology stack or patterns change
- Remove rules that become obvious over time

**Last Updated:** 2026-02-26
