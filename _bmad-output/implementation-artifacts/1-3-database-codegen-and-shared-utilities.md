# Story 1.3: Database Codegen & Shared Utilities

Status: done

<!-- When this story contradicts project-context.md, project-context.md is authoritative. -->

## Story

As a **developer**,
I want auto-generated TypeScript types from the database schema and shared conversion utilities,
So that I have type-safe database access across all packages.

## Acceptance Criteria

1. **Given** the initial migration has run and tables exist, **When** I run `pnpm --filter shared db:types`, **Then** TypeScript types are generated matching the current database schema (ARCH-4) at `packages/shared/src/types/db.ts`.
2. The `toCamelCase()` utility already exists in `packages/shared` (completed in Story 1.1) — verify it is exported and tested.
3. **Given** no data exists, **When** I run `pnpm --filter backend db:seed`, **Then** `tracks` and `milestones` tables are populated with initial metadata matching the `content/milestones/` directory structure.
4. Re-running `pnpm --filter shared db:types` after a new migration updates types without manual intervention.
5. Generated types are importable by all apps and packages via `import type { DB } from '@mycscompanion/shared'`.

## Tasks / Subtasks

- [x] Task 1: Install kysely-codegen in `packages/shared` (AC: #1, #4)
  - [x] 1.1 Install dev deps: `pnpm --filter shared add -D kysely-codegen kysely pg`
    - `kysely` and `pg` are required peers for kysely-codegen to connect to PostgreSQL and introspect schema
    - These are dev-only — `@mycscompanion/shared` has NO runtime database deps
  - [x] 1.2 Add `db:types` script to `packages/shared/package.json`:
    - `"db:types": "kysely-codegen --dialect postgres --out-file ./src/types/db.ts"`
    - kysely-codegen reads `DATABASE_URL` from environment automatically
  - [x] 1.3 Add `dotenv` as dev dep in `packages/shared`: `pnpm --filter shared add -D dotenv`
    - Need to load `.env` for DATABASE_URL when running codegen
    - Update db:types script: `"db:types": "node -e \"require('dotenv').config({path:'../../.env'})\" && kysely-codegen --dialect postgres --out-file ./src/types/db.ts"`
    - OR simpler: `"db:types": "dotenv -e ../../.env -- kysely-codegen --dialect postgres --out-file ./src/types/db.ts"` using `dotenv-cli`
    - Best approach: use `dotenv-cli` as dev dep instead: `pnpm --filter shared add -D dotenv-cli`, then: `"db:types": "dotenv -e ../../.env -- kysely-codegen --dialect postgres --out-file ./src/types/db.ts"`

- [x] Task 2: Configure .gitignore for generated types (AC: #4)
  - [x] 2.1 Add `packages/shared/src/types/db.ts` to root `.gitignore`
    - This file is generated — never committed. Developers run `pnpm --filter shared db:types` after migrations.
  - [x] 2.2 Add a comment in `.gitignore` explaining why: `# Generated by kysely-codegen — run pnpm --filter shared db:types after migrations`

- [x] Task 3: Run initial type generation (AC: #1, #4, #5)
  - [x] 3.1 Ensure PostgreSQL is running: `docker compose up -d`
  - [x] 3.2 Ensure migrations are applied: `pnpm --filter backend db:migrate`
  - [x] 3.3 Run codegen: `pnpm --filter shared db:types`
  - [x] 3.4 Verify `packages/shared/src/types/db.ts` is generated with interfaces for `users`, `tracks`, `milestones` tables and a `DB` interface mapping table names to row types
  - [x] 3.5 Do NOT use `--camel-case` flag — DB columns are snake_case; conversion to camelCase happens at runtime via `toCamelCase()`

- [x] Task 4: Wire generated types into shared package exports (AC: #5)
  - [x] 4.1 Update `packages/shared/src/types/index.ts`:
    - Re-export all types from `./db` (the generated file)
    - Keep the existing placeholder comment updated to note types are now generated
    - Add conditional: the file should gracefully handle the case where `db.ts` doesn't exist yet (developer hasn't run codegen). Use a try/re-export pattern OR document that codegen must run first.
  - [x] 4.2 Create `packages/shared/src/types/api.ts` — placeholder for API request/response types (empty export for now, populated in later stories)
  - [x] 4.3 Create `packages/shared/src/types/domain.ts` — placeholder for shared domain types (empty export for now)
  - [x] 4.4 Update `packages/shared/src/index.ts` barrel to re-export from new type files
  - [x] 4.5 Verify: `import type { DB, Users, Tracks, Milestones } from '@mycscompanion/shared'` works from any app

- [x] Task 5: Update backend `db.ts` to use generated types (AC: #1)
  - [x] 5.1 Modify `apps/backend/src/shared/db.ts`:
    - Replace `Kysely<any>` with `Kysely<DB>` using the generated type
    - Import: `import type { DB } from '@mycscompanion/shared'`
    - Remove the `eslint-disable-next-line @typescript-eslint/no-explicit-any` comment
  - [x] 5.2 Verify: Kysely queries now have full type inference (e.g., `db.selectFrom('users').select('email')` returns typed result)

- [x] Task 6: Create shared constants file (AC: N/A — architecture requirement)
  - [x] 6.1 Create `packages/shared/src/constants.ts` per architecture spec
  - [x] 6.2 Add initial track and milestone constants that match seed data:
    ```typescript
    export const TRACKS = {
      BUILD_YOUR_OWN_DATABASE: 'build-your-own-database',
    } as const

    export const MILESTONES = {
      KV_STORE: 'kv-store',
      STORAGE_ENGINE: 'storage-engine',
      BTREE_INDEXING: 'btree-indexing',
      QUERY_PARSER: 'query-parser',
      TRANSACTIONS: 'transactions',
    } as const
    ```
  - [x] 6.3 Export from `packages/shared/src/index.ts` barrel

- [x] Task 7: Create seed data script (AC: #3)
  - [x] 7.1 Create `apps/backend/src/scripts/seed.ts`
  - [x] 7.2 Seed the `tracks` table with one track: "Build Your Own Database" (slug: `build-your-own-database`)
  - [x] 7.3 Seed the `milestones` table with 5 milestones matching `content/milestones/` directory:

    | position | title | slug | content dir |
    |---|---|---|---|
    | 1 | Simple Key-Value Store | kv-store | 01-kv-store |
    | 2 | Storage Engine | storage-engine | 02-storage-engine |
    | 3 | B-Tree Indexing | btree-indexing | 03-btree-indexing |
    | 4 | Query Parser | query-parser | 04-query-parser |
    | 5 | Transactions | transactions | 05-transactions |

  - [x] 7.4 Use `generateId()` from `../shared/id` for track and milestone IDs
  - [x] 7.5 Script must be idempotent — use `INSERT ... ON CONFLICT DO NOTHING` or check existence first. Use Kysely's `onConflict()` builder.
  - [x] 7.6 Script must import `db` from `../shared/db` and call `destroyDb()` on completion
  - [x] 7.7 Script must load environment variables — add `import 'dotenv/config'` at top (dotenv is already a dep in backend from Story 1.2's kysely.config.ts)
  - [x] 7.8 Add script to `apps/backend/package.json`: `"db:seed": "tsx src/scripts/seed.ts"`
  - [x] 7.9 Create `apps/backend/src/scripts/` directory

- [x] Task 8: Verify and validate (AC: #1, #2, #3, #4, #5)
  - [x] 8.1 Run `pnpm --filter shared db:types` — verify types generated
  - [x] 8.2 Run `pnpm --filter backend db:seed` — verify seed data inserted
  - [x] 8.3 Run `pnpm --filter backend db:seed` again — verify idempotent (no error, no duplicates)
  - [x] 8.4 Run `pnpm typecheck` — verify no type errors across entire monorepo
  - [x] 8.5 Run `pnpm lint` — verify no lint errors
  - [x] 8.6 Run `pnpm test` — verify existing tests still pass
  - [x] 8.7 Verify `toCamelCase()` utility works with a generated type (existing tests in `packages/shared/src/to-camel-case.test.ts` cover this)

## Dev Notes

### Rules (MUST Follow)

**Type Generation (ARCH-4):**
- `kysely-codegen` generates types — NEVER hand-write DB interfaces
- Generated file: `packages/shared/src/types/db.ts` — gitignored
- Do NOT use `--camel-case` flag — DB types must be snake_case to match actual column names
- `toCamelCase()` converts at runtime in route handlers, NOT at type level
- After ANY migration: `pnpm --filter backend db:migrate` then `pnpm --filter shared db:types`

**Package Installation:**
- `pnpm --filter shared add -D <pkg>` for codegen tooling in shared
- `pnpm --filter backend add <pkg>` for backend production deps
- Never install to root unless it's tooling

**Code Style:**
- Named exports only — no default exports
- No `any` type — the whole point of this story is to eliminate `Kysely<any>`
- Explicit return types on exported functions
- `T | null` for absent values — never `undefined`
- Use `satisfies` for type validation, not `as`
- No TS `enum` — use `as const` objects for constants

**Seed Data:**
- Use `generateId()` from `apps/backend/src/shared/id.ts` — never hand-write IDs
- Use `cuid2` for all entity IDs (track IDs, milestone IDs)
- Use Kysely's `onConflict()` for idempotent inserts — NOT raw SQL
- Seed data must match `content/milestones/` directory structure exactly
- Slugs must be URL-safe, kebab-case, matching directory names (without numeric prefix)

**Anti-Patterns:**
- Do NOT use Drizzle — Kysely is authoritative
- Do NOT hand-write DB interfaces — kysely-codegen only
- Do NOT commit generated `db.ts` — it's gitignored
- Do NOT use `--camel-case` on codegen — snake_case types, runtime conversion
- Do NOT create API routes in this story — that's Story 1.4
- Do NOT wire Kysely into Fastify plugins — that's Story 1.4
- Do NOT create test infrastructure — that's Story 1.5
- Do NOT add `@types/pg` to `packages/shared` — it's already a devDep in `apps/backend` where it's needed at compile time. `packages/shared` only needs `pg` as a runtime dependency of `kysely-codegen`
- Do NOT modify `toCamelCase()` — it's already complete and tested from Story 1.1

### Previous Story Intelligence (Story 1.2)

**What was established:**
- `apps/backend/src/shared/db.ts` — Kysely instance with `Kysely<any>` (replace `any` with `DB`)
- `apps/backend/src/shared/id.ts` — `generateId()` using cuid2
- `apps/backend/kysely.config.ts` — kysely-ctl config with dotenv loading from `../../.env`
- `apps/backend/migrations/001_initial_schema.ts` — creates `users`, `tracks`, `milestones` tables
- `docker-compose.yml` — PostgreSQL on port **5433** (changed from 5432 to avoid local conflicts)
- `.env.example` — `DATABASE_URL=postgresql://mycscompanion:mycscompanion@localhost:5433/mycscompanion`
- `dotenv` is already installed as devDep in `apps/backend` (used in kysely.config.ts)

**Learnings from Story 1.2 dev agent:**
- `@types/pg` was needed as devDep for typecheck — already installed in backend
- PostgreSQL port is 5433, not default 5432 — `.env` and `docker-compose.yml` reflect this
- ESLint already ignores `migrations/**` in `apps/backend/eslint.config.js`
- `pg` is CJS — use `import pg from 'pg'` then `pg.Pool` (not `import { Pool } from 'pg'`)

**What was established in Story 1.1:**
- `packages/shared/src/to-camel-case.ts` — deep snake→camel converter, exported and tested
- `packages/shared/src/types/index.ts` — empty placeholder (to be populated here)
- `packages/shared/src/index.ts` — barrel exports `toCamelCase`, `CamelCaseKeys`, and all types
- All 7 workspaces pass `typecheck` and `lint`
- ESLint enforces `no-explicit-any: 'error'` and `no-console: 'error'`

### Project Structure Notes

**Files to create:**
```
packages/shared/
├── src/
│   ├── constants.ts              # NEW — shared constants (track/milestone slugs)
│   └── types/
│       ├── db.ts                 # GENERATED by kysely-codegen (gitignored)
│       ├── api.ts                # NEW — placeholder for API types
│       └── domain.ts             # NEW — placeholder for domain types
apps/backend/
└── src/
    └── scripts/
        └── seed.ts               # NEW — seed data script
```

**Files to modify:**
```
packages/shared/package.json      # ADD devDeps: kysely-codegen, kysely, pg, dotenv-cli; ADD db:types script
packages/shared/src/types/index.ts # UPDATE — re-export from db.ts, api.ts, domain.ts
packages/shared/src/index.ts      # UPDATE — add constants export
apps/backend/src/shared/db.ts     # UPDATE — replace Kysely<any> with Kysely<DB>
apps/backend/package.json         # ADD db:seed script
.gitignore                        # ADD generated db.ts exclusion
```

**Files NOT to touch:**
- `packages/shared/src/to-camel-case.ts` — already complete from Story 1.1
- `packages/shared/src/to-camel-case.test.ts` — already complete
- `apps/backend/src/server.ts` — plugin wiring is Story 1.4
- `apps/backend/src/shared/redis.ts` — Redis wiring is Story 1.4
- `apps/backend/kysely.config.ts` — already configured in Story 1.2
- `apps/backend/migrations/` — no new migrations in this story
- Any files in `apps/webapp/` or `apps/website/`
- Any files in `content/` — read-only reference for seed data

### Reference Implementation Patterns

**db:types script approach (packages/shared/package.json):**
```json
{
  "scripts": {
    "db:types": "dotenv -e ../../.env -- kysely-codegen --dialect postgres --out-file ./src/types/db.ts"
  }
}
```

**Updated db.ts pattern (apps/backend/src/shared/db.ts):**
```typescript
import type { DB } from '@mycscompanion/shared'
import { Kysely, PostgresDialect } from 'kysely'
import pg from 'pg'

if (!process.env['DATABASE_URL']) {
  throw new Error('DATABASE_URL environment variable is required')
}

const dialect = new PostgresDialect({
  pool: new pg.Pool({
    connectionString: process.env['DATABASE_URL'],
  }),
})

export const db = new Kysely<DB>({ dialect })

export async function destroyDb(): Promise<void> {
  await db.destroy()
}
```

**types/index.ts re-export pattern:**
```typescript
/**
 * Shared types for mycscompanion.
 * DB types generated by kysely-codegen — run `pnpm --filter shared db:types` after migrations.
 */
export type * from './db'
export type * from './api'
export type * from './domain'
```

**Seed script pattern (apps/backend/src/scripts/seed.ts):**
```typescript
import 'dotenv/config'
import { db, destroyDb } from '../shared/db'
import { generateId } from '../shared/id'

async function seed(): Promise<void> {
  console.info('Seeding database...')

  // Seed track
  const trackId = generateId()
  await db
    .insertInto('tracks')
    .values({
      id: trackId,
      name: 'Build Your Own Database',
      slug: 'build-your-own-database',
      description: 'Learn computer science by building a database from scratch in Go.',
    })
    .onConflict((oc) => oc.column('slug').doNothing())
    .execute()

  // Retrieve the track (may already exist from previous run)
  const track = await db
    .selectFrom('tracks')
    .select('id')
    .where('slug', '=', 'build-your-own-database')
    .executeTakeFirstOrThrow()

  // Seed milestones
  const milestones = [
    { position: 1, title: 'Simple Key-Value Store', slug: 'kv-store', description: 'Build a key-value store that persists data to disk.' },
    { position: 2, title: 'Storage Engine', slug: 'storage-engine', description: 'Implement a log-structured storage engine with compaction.' },
    { position: 3, title: 'B-Tree Indexing', slug: 'btree-indexing', description: 'Add B-tree indexing for efficient key lookups.' },
    { position: 4, title: 'Query Parser', slug: 'query-parser', description: 'Build a SQL-like query parser and executor.' },
    { position: 5, title: 'Transactions', slug: 'transactions', description: 'Implement ACID transactions with write-ahead logging.' },
  ]

  for (const m of milestones) {
    await db
      .insertInto('milestones')
      .values({
        id: generateId(),
        track_id: track.id,
        title: m.title,
        slug: m.slug,
        position: m.position,
        description: m.description,
      })
      .onConflict((oc) => oc.columns(['track_id', 'slug']).doNothing())
      .execute()
  }

  console.info('Seed complete.')
}

seed()
  .catch((err) => {
    console.error('Seed failed:', err)
    process.exitCode = 1
  })
  .finally(() => destroyDb())
```

**Note on seed script `console` usage:** The seed script is a CLI tool run manually, NOT part of the Fastify server. Using `console.info`/`console.error` is acceptable here. Add `/* eslint-disable no-console */` at the top of the file since ESLint enforces `no-console: 'error'` globally.

**Constants pattern (packages/shared/src/constants.ts):**
```typescript
export const TRACKS = {
  BUILD_YOUR_OWN_DATABASE: 'build-your-own-database',
} as const

export const MILESTONES = {
  KV_STORE: 'kv-store',
  STORAGE_ENGINE: 'storage-engine',
  BTREE_INDEXING: 'btree-indexing',
  QUERY_PARSER: 'query-parser',
  TRANSACTIONS: 'transactions',
} as const
```

### Downstream Dependencies

| Story | What It Needs From 1.3 |
|---|---|
| 1.4 Fastify Bootstrap | `Kysely<DB>` typed instance for plugin injection |
| 1.5 Test Infrastructure | Generated `DB` type for typed test transaction wrapper |
| 2.x User Auth | `Users` type for profile operations |
| 4.x Curriculum | `Tracks`, `Milestones` types + seed data for content API |
| All API stories | `toCamelCase()` for DB→API conversion in route handlers |

### References

- [Source: _bmad-output/planning-artifacts/architecture.md#Data-Architecture — kysely-codegen config, type generation]
- [Source: _bmad-output/planning-artifacts/architecture.md#Naming-Patterns — snake_case DB, camelCase API, toCamelCase()]
- [Source: _bmad-output/planning-artifacts/architecture.md#packages/shared — File structure with db.ts, api.ts, domain.ts, constants.ts]
- [Source: _bmad-output/planning-artifacts/epics.md#Story-1.3 — Acceptance criteria and story definition]
- [Source: _bmad-output/project-context.md#Technology-Stack — Kysely, kysely-codegen, PostgreSQL 16]
- [Source: _bmad-output/project-context.md#Development-Workflow — After schema changes: db:migrate then db:types]
- [Source: _bmad-output/implementation-artifacts/1-2-database-foundation-and-migration-system.md — Previous story context, dotenv pattern, port 5433]
- [Source: _bmad-output/implementation-artifacts/1-1-monorepo-scaffold-and-local-dev-environment.md — Monorepo structure, toCamelCase, ESLint config]
- [Source: content/milestones/ — 5 milestone directories for seed data alignment]
- [Source: https://github.com/RobinBlomberg/kysely-codegen — kysely-codegen CLI flags and config]

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- Backend `moduleResolution: "NodeNext"` requires `.js` extensions on relative imports in shared barrel. Added `.js` extensions to `packages/shared/src/index.ts` and `packages/shared/src/types/index.ts` to satisfy both `bundler` (shared) and `NodeNext` (backend) resolution modes.
- Seed script: `import 'dotenv/config'` cannot load `../../.env` because CWD is `apps/backend/` and dotenv defaults to CWD. Used `dotenv-cli` in the `db:seed` script command (`dotenv -e ../../.env -- tsx src/scripts/seed.ts`) to preload env before module evaluation, matching the pattern used by `db:types` in shared.

### Completion Notes List

- Installed kysely-codegen, kysely, pg, dotenv-cli as devDeps in `@mycscompanion/shared`
- Added `db:types` script using dotenv-cli to load root `.env`
- Generated `packages/shared/src/types/db.ts` with DB, Users, Tracks, Milestones interfaces (snake_case columns)
- Added `db.ts` to `.gitignore` with explanatory comment
- Created `api.ts` and `domain.ts` placeholder type files
- Updated barrel exports with `.js` extensions for NodeNext compatibility
- Created `packages/shared/src/constants.ts` with TRACKS and MILESTONES `as const` objects
- Replaced `Kysely<any>` with `Kysely<DB>` in `apps/backend/src/shared/db.ts` — full type inference now active
- Created idempotent seed script at `apps/backend/src/scripts/seed.ts` using `generateId()`, Kysely `onConflict()`, and `destroyDb()` cleanup
- Added `db:seed` script to backend using dotenv-cli
- All 7 packages pass typecheck, lint, and tests (10/10 existing tests pass, 0 regressions)

### Senior Developer Review (AI)

**Reviewer:** Ducdo on 2026-02-26
**Review Model:** Claude Opus 4.6 (adversarial code review)

**5 issues found — all fixed:**

1. **HIGH — Seed script hardcoded slugs instead of shared constants** (Fixed)
   - `seed.ts` now imports `TRACKS`/`MILESTONES` from `@mycscompanion/shared` instead of duplicating string literals
2. **MEDIUM — No graceful fallback when generated `db.ts` doesn't exist** (Fixed)
   - Added `postinstall` script to `packages/shared` that creates a stub `db.ts` if missing, preventing typecheck failures on fresh clones
3. **MEDIUM — Zero new tests for Story 1.3** (Fixed)
   - Added `packages/shared/src/constants.test.ts` with 3 tests covering `TRACKS` and `MILESTONES` exports
4. **LOW — Seed script used sequential inserts instead of batch** (Fixed)
   - Refactored to single `values([...])` batch insert for milestones
5. **LOW — Seed script had no transaction wrapper** (Fixed)
   - Wrapped all seed operations in `db.transaction().execute()`

**Post-fix verification:** 7/7 typecheck, 7/7 lint, 13/13 tests (10 existing + 3 new)

### Change Log

- 2026-02-26: Implemented Story 1.3 — kysely-codegen type generation, shared constants, seed data script, typed Kysely<DB> instance
- 2026-02-26: Code review fixes — shared constants in seed, postinstall stub, constants tests, batch insert, transaction wrapper

### File List

**New files:**
- `packages/shared/src/constants.ts`
- `packages/shared/src/constants.test.ts`
- `packages/shared/src/types/api.ts`
- `packages/shared/src/types/domain.ts`
- `packages/shared/src/types/db.ts` (generated, gitignored)
- `apps/backend/src/scripts/seed.ts`

**Modified files:**
- `packages/shared/package.json` (added devDeps: kysely-codegen, kysely, pg, dotenv-cli; added db:types + postinstall scripts)
- `packages/shared/src/index.ts` (added constants export, .js extensions)
- `packages/shared/src/types/index.ts` (re-export db, api, domain types with .js extensions)
- `apps/backend/src/shared/db.ts` (Kysely<any> → Kysely<DB>)
- `apps/backend/package.json` (added dotenv-cli devDep, db:seed script)
- `.gitignore` (added generated db.ts exclusion)
- `pnpm-lock.yaml` (updated from dependency installs)
